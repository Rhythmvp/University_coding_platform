<%- include('partials/head') %>
<%- include('partials/header') %>

<!-- Admin Assessments Section -->
<section class="admin-assessments-section py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold">Manage Assessments</h2>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>Create Assessment
                    </button>
                </div>
            </div>
        </div>

        <!-- Assessments List -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">All Assessments</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Questions</th>
                                        <th>Submissions</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assessments-table">
                                    <!-- Assessments will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Create Assessment Modal -->
<div class="modal fade" id="createAssessmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-assessment-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" id="assessment-title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="assessment-type" required>
                                <option value="">Select Type</option>
                                <option value="mcq">MCQ Only</option>
                                <option value="coding">Coding Only</option>
                                <option value="mixed">Mixed</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="assessment-description" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time Limit (minutes)</label>
                            <input type="number" class="form-control" id="assessment-time-limit" value="60" min="15" max="300">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="assessment-status">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- MCQ Questions Section -->
                    <div id="mcq-section" style="display: none;">
                        <h6 class="mt-4 mb-3">MCQ Questions</h6>
                        <div id="mcq-questions">
                            <div class="mcq-question-item border rounded p-3 mb-3">
                                <div class="row">
                                    <div class="col-12 mb-2">
                                        <label class="form-label">Question 1</label>
                                        <textarea class="form-control" name="mcq-question" rows="2" placeholder="Enter question text"></textarea>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Option A</label>
                                        <input type="text" class="form-control" name="mcq-option-a" placeholder="Option A">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Option B</label>
                                        <input type="text" class="form-control" name="mcq-option-b" placeholder="Option B">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Option C</label>
                                        <input type="text" class="form-control" name="mcq-option-c" placeholder="Option C">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Option D</label>
                                        <input type="text" class="form-control" name="mcq-option-d" placeholder="Option D">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Correct Answer</label>
                                        <select class="form-select" name="mcq-correct">
                                            <option value="">Select correct answer</option>
                                            <option value="A">A</option>
                                            <option value="B">B</option>
                                            <option value="C">C</option>
                                            <option value="D">D</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Points</label>
                                        <input type="number" class="form-control" name="mcq-points" value="1" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMCQQuestion()">
                            <i class="fas fa-plus me-1"></i>Add MCQ Question
                        </button>
                    </div>

                    <!-- Coding Questions Section -->
                    <div id="coding-section" style="display: none;">
                        <h6 class="mt-4 mb-3">Coding Questions</h6>
                        <div id="coding-questions">
                            <div class="coding-question-item border rounded p-3 mb-3">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Question Title</label>
                                        <input type="text" class="form-control" name="coding-title" placeholder="Question title">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Difficulty</label>
                                        <select class="form-select" name="coding-difficulty">
                                            <option value="easy">Easy</option>
                                            <option value="medium">Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="coding-description" rows="3" placeholder="Question description"></textarea>
                                    </div>
                                    <div class="col-12 mb-2">
                                        <label class="form-label">Starter Code</label>
                                        <textarea class="form-control" name="coding-starter-code" rows="4" placeholder="Starter code (optional)"></textarea>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label">Points</label>
                                        <input type="number" class="form-control" name="coding-points" value="10" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="addCodingQuestion()">
                            <i class="fas fa-plus me-1"></i>Add Coding Question
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAssessment()">Create Assessment</button>
            </div>
        </div>
    </div>
</div>

<style>
.mcq-question-item, .coding-question-item {
    background: #f8f9fa;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.badge {
    font-size: 0.75rem;
}
</style>

<script>
let mcqQuestionCount = 1;
let codingQuestionCount = 1;

document.addEventListener('DOMContentLoaded', function() {
    loadAssessments();
    
    // Show/hide question sections based on assessment type
    document.getElementById('assessment-type').addEventListener('change', function() {
        const type = this.value;
        const mcqSection = document.getElementById('mcq-section');
        const codingSection = document.getElementById('coding-section');
        
        if (type === 'mcq' || type === 'mixed') {
            mcqSection.style.display = 'block';
        } else {
            mcqSection.style.display = 'none';
        }
        
        if (type === 'coding' || type === 'mixed') {
            codingSection.style.display = 'block';
        } else {
            codingSection.style.display = 'none';
        }
    });
});

async function loadAssessments() {
    try {
        const response = await fetch('/api/admin/assessments');
        const assessments = await response.json();
        
        const container = document.getElementById('assessments-table');
        container.innerHTML = '';
        
        assessments.forEach(assessment => {
            const row = document.createElement('tr');
            const totalQuestions = (assessment.questions ? assessment.questions.length : 0) + 
                                 (assessment.codingQuestions ? assessment.codingQuestions.length : 0);
            
            row.innerHTML = `
                <td>${assessment.title}</td>
                <td><span class="badge bg-${assessment.type === 'mcq' ? 'primary' : assessment.type === 'coding' ? 'success' : 'warning'}">${assessment.type.toUpperCase()}</span></td>
                <td><span class="badge bg-${assessment.isActive ? 'success' : 'secondary'}">${assessment.isActive ? 'Active' : 'Inactive'}</span></td>
                <td>${totalQuestions}</td>
                <td>0</td>
                <td>${new Date(assessment.createdAt).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editAssessment('${assessment._id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAssessment('${assessment._id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            container.appendChild(row);
        });
        
        if (assessments.length === 0) {
            container.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No assessments created yet</td></tr>';
        }
    } catch (error) {
        console.error('Error loading assessments:', error);
    }
}

function openCreateModal() {
    new bootstrap.Modal(document.getElementById('createAssessmentModal')).show();
}

function addMCQQuestion() {
    mcqQuestionCount++;
    const container = document.getElementById('mcq-questions');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'mcq-question-item border rounded p-3 mb-3';
    questionDiv.innerHTML = `
        <div class="row">
            <div class="col-12 mb-2">
                <label class="form-label">Question ${mcqQuestionCount}</label>
                <textarea class="form-control" name="mcq-question" rows="2" placeholder="Enter question text"></textarea>
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Option A</label>
                <input type="text" class="form-control" name="mcq-option-a" placeholder="Option A">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Option B</label>
                <input type="text" class="form-control" name="mcq-option-b" placeholder="Option B">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Option C</label>
                <input type="text" class="form-control" name="mcq-option-c" placeholder="Option C">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Option D</label>
                <input type="text" class="form-control" name="mcq-option-d" placeholder="Option D">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Correct Answer</label>
                <select class="form-select" name="mcq-correct">
                    <option value="">Select correct answer</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Points</label>
                <input type="number" class="form-control" name="mcq-points" value="1" min="1">
            </div>
        </div>
    `;
    container.appendChild(questionDiv);
}

function addCodingQuestion() {
    codingQuestionCount++;
    const container = document.getElementById('coding-questions');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'coding-question-item border rounded p-3 mb-3';
    questionDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label">Question Title</label>
                <input type="text" class="form-control" name="coding-title" placeholder="Question title">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Difficulty</label>
                <select class="form-select" name="coding-difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <div class="col-12 mb-2">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="coding-description" rows="3" placeholder="Question description"></textarea>
            </div>
            <div class="col-12 mb-2">
                <label class="form-label">Starter Code</label>
                <textarea class="form-control" name="coding-starter-code" rows="4" placeholder="Starter code (optional)"></textarea>
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">Points</label>
                <input type="number" class="form-control" name="coding-points" value="10" min="1">
            </div>
        </div>
    `;
    container.appendChild(questionDiv);
}

async function createAssessment() {
    const assessmentData = {
        title: document.getElementById('assessment-title').value,
        description: document.getElementById('assessment-description').value,
        type: document.getElementById('assessment-type').value,
        timeLimit: parseInt(document.getElementById('assessment-time-limit').value),
        isActive: document.getElementById('assessment-status').value === 'true',
        questions: [],
        codingQuestions: []
    };
    
    // Collect MCQ questions
    const mcqItems = document.querySelectorAll('.mcq-question-item');
    mcqItems.forEach(item => {
        const question = item.querySelector('[name="mcq-question"]').value;
        const optionA = item.querySelector('[name="mcq-option-a"]').value;
        const optionB = item.querySelector('[name="mcq-option-b"]').value;
        const optionC = item.querySelector('[name="mcq-option-c"]').value;
        const optionD = item.querySelector('[name="mcq-option-d"]').value;
        const correct = item.querySelector('[name="mcq-correct"]').value;
        const points = parseInt(item.querySelector('[name="mcq-points"]').value);
        
        if (question && optionA && optionB && optionC && optionD && correct) {
            assessmentData.questions.push({
                question,
                options: [optionA, optionB, optionC, optionD],
                correctAnswer: correct,
                points
            });
        }
    });
    
    // Collect coding questions
    const codingItems = document.querySelectorAll('.coding-question-item');
    codingItems.forEach(item => {
        const title = item.querySelector('[name="coding-title"]').value;
        const description = item.querySelector('[name="coding-description"]').value;
        const difficulty = item.querySelector('[name="coding-difficulty"]').value;
        const starterCode = item.querySelector('[name="coding-starter-code"]').value;
        const points = parseInt(item.querySelector('[name="coding-points"]').value);
        
        if (title && description) {
            assessmentData.codingQuestions.push({
                title,
                description,
                difficulty,
                starterCode,
                points,
                testCases: [
                    { input: "1", output: "1", description: "Basic test case" }
                ]
            });
        }
    });
    
    try {
        const response = await fetch('/api/admin/assessments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(assessmentData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Assessment created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('createAssessmentModal')).hide();
            document.getElementById('create-assessment-form').reset();
            loadAssessments();
        } else {
            alert('Error creating assessment: ' + result.error);
        }
    } catch (error) {
        console.error('Error creating assessment:', error);
        alert('Error creating assessment. Please try again.');
    }
}

function editAssessment(assessmentId) {
    alert('Edit assessment: ' + assessmentId);
}

async function deleteAssessment(assessmentId) {
    if (!confirm('Are you sure you want to delete this assessment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/assessments/${assessmentId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Assessment deleted successfully!');
            loadAssessments();
        } else {
            const result = await response.json();
            alert('Error deleting assessment: ' + result.error);
        }
    } catch (error) {
        console.error('Error deleting assessment:', error);
        alert('Error deleting assessment. Please try again.');
    }
}
</script>

<%- include('partials/footer') %> 